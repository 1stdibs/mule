<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesource.org/schema/mule/core/2.2"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:spring="http://www.springframework.org/schema/beans"
    xmlns:test="http://www.mulesource.org/schema/mule/test/2.2"
    xmlns:script="http://www.mulesource.org/schema/mule/scripting/2.2"
    xmlns:vm="http://www.mulesource.org/schema/mule/vm/2.2"
    xsi:schemaLocation="
               http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
               http://www.mulesource.org/schema/mule/core/2.2 http://www.mulesource.org/schema/mule/core/2.2/mule.xsd
               http://www.mulesource.org/schema/mule/vm/2.2 http://www.mulesource.org/schema/mule/vm/2.2/mule-vm.xsd
               http://www.mulesource.org/schema/mule/scripting/2.2 http://www.mulesource.org/schema/mule/scripting/2.2/mule-scripting.xsd
               http://www.mulesource.org/schema/mule/test/2.2 http://www.mulesource.org/schema/mule/test/2.2/mule-test.xsd">

    <vm:connector name="queue" queueEvents="true" />

    <script:transformer name="duplicateTransformer">
        <script:script engine="groovy">
            return src * 2
        </script:script>
    </script:transformer>

    <script:transformer name="failingIncTransformer">
        <script:script engine="groovy">
            import org.mule.api.transformer.TransformerException;
            import org.mule.config.i18n.CoreMessages;
    
            if (src % 2 == 0)
            {
              throw new TransformerException(CoreMessages.failedToReadPayload());
            }
            else
            {
              return src + 1;
            }
        </script:script>
    </script:transformer>

    <model>
        <service name="TestSyncTransactionalErrorHandling">
            <inbound>
                <vm:inbound-endpoint name="in" path="in"
                    synchronous="true" transformer-refs="failingIncTransformer" />
            </inbound>
            <outbound>
                <pass-through-router>
                    <vm:outbound-endpoint name="out"
                        path="out" synchronous="true" />
                </pass-through-router>
            </outbound>
            <routeable-exception-strategy>
                <rollback-transaction
                    exception-pattern="*" />
                <pass-through-router>
                    <vm:outbound-endpoint name="exception" path="exception"
                        transformer-refs="duplicateTransformer" synchronous="true" />
                </pass-through-router>
            </routeable-exception-strategy>
        </service>
    </model>
</mule>