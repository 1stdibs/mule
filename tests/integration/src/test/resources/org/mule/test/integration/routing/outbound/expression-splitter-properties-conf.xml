<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:spring="http://www.springframework.org/schema/beans"
      xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
      xmlns:test="http://www.mulesoft.org/schema/mule/test"
      xmlns:mulexml="http://www.mulesoft.org/schema/mule/xml"
      xsi:schemaLocation="
       http://www.mulesoft.org/schema/mule/xml http://www.mulesoft.org/schema/mule/xml/3.2/mule-xml.xsd
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/3.2/mule.xsd
       http://www.mulesoft.org/schema/mule/test http://www.mulesoft.org/schema/mule/test/3.2/mule-test.xsd
       http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/3.2/mule-vm.xsd">


    <flow name="PropertiesPropagation">
        <vm:inbound-endpoint path="in" exchange-pattern="request-response"/>

        <message-properties-transformer scope="outbound" >
            <add-message-property key="propOut" value="test" />
        </message-properties-transformer>
        <message-properties-transformer scope="invocation" >
            <add-message-property key="propInvk" value="test" />
        </message-properties-transformer>
        <message-properties-transformer scope="session" >
            <add-message-property key="propSession" value="test" />
        </message-properties-transformer>

        <response>
            <message-properties-transformer scope="session" >
                <add-message-property key="responsePropInvk" value="#[header:INVOCATION:propInvk]" />
            </message-properties-transformer>
            <message-properties-transformer scope="session" >
                <add-message-property key="responsePropSession" value="#[header:SESSION:propSession]" />
            </message-properties-transformer>
        </response>

        <splitter evaluator="xpath" expression="/message/document"/>

        <message-properties-transformer scope="session" >
            <add-message-property key="splitterPropOut" value="#[header:OUTBOUND:propOut]" />
        </message-properties-transformer>
        <message-properties-transformer scope="session" >
            <add-message-property key="splitterPropInvk" value="#[header:INVOCATION:propInvk]" />
        </message-properties-transformer>
        <message-properties-transformer scope="session" >
            <add-message-property key="splitterPropSession" value="#[header:SESSION:propSession]" />
        </message-properties-transformer>

        <mulexml:dom-to-xml-transformer/>
        <collection-aggregator/>

        <message-properties-transformer scope="session">
            <add-message-property key="aggregatorPropInvk" value="#[header:INVOCATION:propInvk]" />
        </message-properties-transformer>
        <message-properties-transformer scope="session" >
            <add-message-property key="aggregatorPropSession" value="#[header:SESSION:propSession]" />
        </message-properties-transformer>

    </flow>

</mule>
