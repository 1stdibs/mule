<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesource.org/schema/mule/core/2.2"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:jbossts="http://www.mulesource.org/schema/mule/jbossts/2.2"
      xmlns:vm="http://www.mulesource.org/schema/mule/vm/2.2"
      xmlns:jms="http://www.mulesource.org/schema/mule/jms/2.2"
      xmlns:scripting="http://www.mulesource.org/schema/mule/scripting/2.2"
      xsi:schemaLocation="
	http://www.mulesource.org/schema/mule/jbossts/2.2 http://www.mulesource.org/schema/mule/jbossts/2.2/mule-jbossts.xsd
	http://www.mulesource.org/schema/mule/core/2.2 http://www.mulesource.org/schema/mule/core/2.2/mule.xsd
	http://www.mulesource.org/schema/mule/vm/2.2 http://www.mulesource.org/schema/mule/vm/2.2/mule-vm.xsd
	http://www.mulesource.org/schema/mule/jms/2.2 http://www.mulesource.org/schema/mule/jms/2.2/mule-jms.xsd
	http://www.mulesource.org/schema/mule/scripting/2.2 http://www.mulesource.org/schema/mule/scripting/2.2/mule-scripting.xsd">

    <jbossts:transaction-manager>
    </jbossts:transaction-manager>

    <jms:activemq-connector name="jmsConnector" disableTemporaryReplyToDestinations="true"/>

    <model name="testModel">
        <service name="addDataToQueue">
            <inbound>
                <vm:inbound-endpoint path="in" synchronous="true"/>
            </inbound>
            <outbound>
                <pass-through-router>
                    <jms:outbound-endpoint queue="fcs.cache.update.queue"
                                           connector-ref="jmsConnector" synchronous="true">
                    </jms:outbound-endpoint>
                </pass-through-router>
            </outbound>
        </service>

        <service name="startBatch">
            <inbound>
                <vm:inbound-endpoint path="startBatch" synchronous="true"/>
            </inbound>
            <outbound>
                <pass-through-router>
                    <jms:outbound-endpoint queue="fcs.cache.xa.batch.queue" connector-ref="jmsConnector"
                                           synchronous="true"/>
                </pass-through-router>
            </outbound>
        </service>
 
        <service name="processBatchData">
            <inbound>
                <jms:inbound-endpoint queue="fcs.cache.xa.batch.queue" connector-ref="jmsConnector"
                                      responseTimeout="10000">
                </jms:inbound-endpoint>
            </inbound>
            <scripting:component>
                <scripting:script engine="groovy"><![CDATA[
                    import org.mule.api.*;

         			String jmsUrl = "jms://fcs.cache.update.queue?connector=jmsConnector";
		        	long timeout = 100L;
                    String result = "";

			        MuleMessage muleMessage = eventContext.requestEvent(jmsUrl, timeout);
			        while (muleMessage != null)
			        {
			            result = result + "message";
				        muleMessage = eventContext.requestEvent(jmsUrl, timeout);
			        }
                    return result;
                ]]>
                </scripting:script>
            </scripting:component>

            <outbound>
                <pass-through-router>
                    <jms:outbound-endpoint queue="status.queue"
                                           connector-ref="jmsConnector">
                    </jms:outbound-endpoint>
                </pass-through-router>
            </outbound>
        </service>
    </model>
</mule>

